\documentclass{elsarticle}
\usepackage{amsfonts,xcolor}
\usepackage{amssymb}
\usepackage{amsmath}
\newcommand{\X}{\mathrm{X}}
\newcommand{\Xh}{\hat{\mathrm{X}}}
\newcommand{\transpose}{^\mathrm{T}}
\usepackage{geometry}
\usepackage{url}
\usepackage[boxed]{algorithm2e}
\usepackage{algorithmicx,algpseudocode}
\newcommand{\argmax}{\operatornamewithlimits{argmax}}
\newcommand{\argmin}{\operatornamewithlimits{argmin}}

\begin{document}
<<setup, include=FALSE, cache=FALSE,eval=FALSE>>=
options(xtable.comment = FALSE)
options(replace.assign=TRUE,width=90)
options( digits = 4 )
# knit_hooks$set(rgl = hook_rgl)
# head(hook_rgl)  # the hook function is defined as this
library(ANTsR)
library(boot)
library(xtable)
library(grid)
library(png)
library(abind)
library(grDevices)
@

\title{Sparse Canonical Correlation Analysis Relates Network-level Atrophy 
to Multivariate Cognitive Measures in Neurodegenerative Diseases}
\author{Brian B. Avants}
\begin{abstract}
We use novel multivariate statistical methods to associate network level gray matter (GM) atrophy with multiple domain-specific psychometric measures in patients with Alzheimer’s disease (AD) or frontotemporal lobar degeneration (FTLD). Ninety-nine patients with Alzheimer’s disease, behavioral-variant frontotemporal dementia, semantic variant primary progressive aphasia, non-fluent/agrammatic primary progressive aphasia, or corticobasal syndrome were studied. Sparse canonical correlation analysis (SCCAN) was used to relate GM density to the Philadelphia Brief Assessment of Cognition (PBAC) psychometric battery. PBAC-defined cognitive domains of language, visuospatial functioning, episodic memory, executive control, and social functioning were associated with unique areas of reduced GM density, and these informed clinical diagnosis. In conclusion, multivariate techniques associate diagnostically-relevant cognitive deficits with biologically-plausible brain regions in neurodegenerative diseases.
\end{abstract}
\begin{keyword}
Alzheimer disease; frontotemporal lobar degeneration; Philadelphia Brief Assessment of Cognition, PBAC, MRI, sparse canonical correlation analysis.
\end{keyword}
\maketitle
\section{Introduction}

\cite{Norman2006}


Frontotemporal lobar degeneration (FTLD) is a progressive neurodegenerative disorder associated with imaging and pathological findings of frontal and temporal disease1,2.  Several FTLD phenotypes have been identified, including patients with a disorder of social comportment and executive functioning (bvFTD); a non-fluent/agrammatic variant of primary progressive aphasia (naPPA), also known as progressive non-fluent aphasia; a semantic variant of primary progressive aphasia  (svPPA), also known as semantic dementia; and corticobasal syndrome (CBS).  A common test used to screen for cognitive deficits in dementia is the Mini-Mental State Examination.3   However, it is now well understood that the MMSE does not assess the behavioral and cognitive deficits associated with FTLD5.  Other tests have been developed to screen and compare patients with dementia syndromes, including the Frontal Assessment Battery6 (FAB); the Addenbrooke Cognitive Examination7 (ACE); and the Montreal Cognitive Assessment (MoCA)8.

The Philadelphia Brief Assessment of Cognition9,10 (PBAC) was developed to provide an economical means to screen and assess important domains of cognitive and behavioral impairment associated with AD and FTLD spectrum phenotypes.  The PBAC requires about 12 minutes for administration and scoring.  An important component of the PBAC is the construction of sub-scales designed to assess specific cognitive and behavioral/ comportment deficits that typify AD and FTLD syndromes, including executive/ working memory, language, visuospatial/ constructional skills, verbal/ visual episodic memory, and behavior/ social comportment.  Dementia severity is assessed by summing all PBAC sub-scales.  Recent research with the PBAC has demonstrated that AD and FTLD patients present with specific areas of impairment on sub-scales that correspond to phenotypic syndromes10.   

The current study extends previous research with the PBAC (Libon et al., 2011) by examining the gray matter neuroimaging correlates of PBAC’s cognitive and social measurements in a large number of AD and FTLD patients.  We employ a new data-driven machine learning technique, sparse canonical correlation analysis for neuroimaging (SCCAN), to associate such high-dimensional imaging measurements with the full information provided by a multivariate psychometric battery such as PBAC.  Specifically, this approach allows an optimal weighting of psychometric sub-scales (as opposed to averaging their values) such that the relationship with neuroimaging is maximized.  At the same time, SCCAN optimizes and selects regions of gray matter (GM) to maximize correlation with psychometrics.  This results in a set of gray matter regions that may be interpreted as the network most-associated with the given psychometric domain.  SCCAN previously identified covariation between GM and diffusion tensor imaging white matter (WM) changes that optimally discriminate between CSF- and autopsy-defined patients with AD and FTLD11.  The purpose of the current research is to test the hypothesis that SCCAN may employ individual PBAC sub-scales to extract GM networks that are significantly affected in patients with a specific phenotypic diagnosis.  This would provide additional criterion validity for both the PBAC and multivariate techniques such as SCCAN, and establish a novel strategy for performing multivariate analyses of brain and behavior. 

MACHINE LEARNING BACKGROUND SECTION


\section{Methods}
\subsection{Patients:}  Individuals participating in the current research were drawn from a corpus of 270 patients, previously described10.  Dementia patients were evaluated by experienced behavioral neurologists (AC, HBC, RGG, MG) and classified clinically on the basis of previously published criteria2, 12-14.  A research diagnosis was made on the basis of an independent review of a semi-structured history obtained from patients and their families and a detailed neurologic examination.  At least two trained reviewers from a consensus committee (inter-rater reliability, r= 0.91, p< 0.001) confirmed patients’ clinical diagnosis and presence of a specific dementia syndrome involving AD or FTLD. Discrepancies were resolved based on group discussion and follow-up assessment.  The PBAC was not used for the initial diagnosis of research participants.  

The clinical diagnosis of dementia was consistent with serum studies, clinical studies of cerebrospinal fluid (when available), clinical imaging studies such as MRI or CT, and functional neuroimaging studies such as SPECT or PET (these studies were not available to the consensus committee).  Exclusion criteria included the presence of other neurologic conditions such as stroke or hydrocephalus, primary psychiatric disorders (e.g., major depression, psychosis), or a systemic illness that can interfere with cognitive functioning.  Some patients were taking a cholinesterase inhibitor (e.g. donepezil, galantamine), memantine, or a non-sedating anti-depressant (e.g., serotonin-specific re-uptake inhibitors such as sertraline), or an atypical neuroleptic agent (e.g., quetiapine) consistent with clinical care; however, no patient demonstrated evidence of sedation.  The current research examined patients with AD (n= 23), behavioral variant-FTD (bvFTD; n= 31), semantic variant-primary progressive aphasia (svPPA; n= 14), nonfluent/ agrammatic-primary progressive aphasia (naPPA; n= 14) and corticobasal syndrome (CBS; n= 17).  The imaging analysis also included a small group of elderly controls (n= 9) who were living independently in the community and not taking psychoactive medications.  Normal control participants presented with no cognitive complaints or impaired instrumental activities of daily living.  Table 1 summarizes participant demographic features.  This research was approved by the University of Pennsylvania Institutional Review Board and informed consent was obtained consistent with the Declaration of Helsinki.

% [Insert Table 1 About Here]

	The Philadelphia Brief Assessment of Cognition (PBAC):  Full details regarding the rationale and construction of the PBAC can be found elsewhere9,10.  The PBAC consists of 15 variables including 11 tests and 2 rating scales.  These variables are grouped into five sub-scales measuring: working memory/ executive control, language, visuospatial/ constructional ability, verbal/ visual episodic memory, and behavior/ social comportment.  The total PBAC score ranges between 0-93. 

	\subsection{Image acquisition}  All images were acquired with a Siemens Trio 3.0 tesla MRI scanner.  Following a rapid sagittal T1-weighted scan to determine patient position, a T1-weighted structural image was acquired with TR= 1620ms, TE= 3ms, slice thickness= 1mm, in-plane resolution= 0.9766mm x 0.9766mm, FOV= 256 × 192. 

	\subsection{Image processing}  The imaging analysis is based on the publicly available and open-source Advanced Normalization Tools (ANTs, http://www.picsl.upenn.edu/ANTs/)
 and the associated pipelining framework PipeDream (http://neuropipedream.sourceforge.net).  PipeDream automates and quality-assures ANTs processing via a single parameter file and data organization hierarchy.  Each patient’s T1 imaging data are inhomogeneity corrected via the N4 bias correction algorithm15.  PipeDream then performs diffeomorphic normalization via the top-performing symmetric normalization methodology available in ANTs16-18 to map each subject to a population-specific template built from the same scanner and imaging parameters.  The template contains prior labeling and probability maps that are used to guide both brain extraction and neuroanatomical segmentation.  Segmentation is performed with a Markov Random Field approach18 implemented in the ANTs toolkit which has been validated on publicly-available datasets.  GM probability maps are then smoothed by a 3mm Gaussian kernel, mapped to the template space, and down-sampled to 2mm resolution.  These normalized GM probability maps are used for subsequent multivariate correlation with PBAC.

	\subsection{Dimensionality reduction/ Statistical Analysis}  Traditional voxel-wise approaches to neuroimage analyses suffer from the multiple comparisons problem because they perform repeated tests on correlated variables at millions of locations in the brain.  If effects are relatively subtle, the subsequent statistical corrections necessary to alleviate this multiple comparisons problem may be overly conservative.  In this study, rather than perform voxel-wise testing, we employ a dimensionality reduction method implemented in SCCAN11.  Briefly, this is an imaging-specific extension of sparse canonical correlation analysis19,20  that is itself a sparse and multi-modality extension to the classic dimensionality reduction methods known as principal component analysis (PCA) and Hotelling’s classic canonical correlation analysis (CCA)21.

Classical CCA may be used to compute a multivariate association between two different views of a dataset.  One of Hotelling’s original examples, for instance, associated measurements of height and weight to measurements of cognition.  More recently, sparse versions of CCA have been developed to increase the interpretability of the output.  Sparse CCA methods, like classical CCA, compute eigenvectors that maximize the Pearson correlation between the input modalities.  In this work, we use sparse CCA in a similar way to Hotelling’s classic study, i.e. to associate two different types of measurements, one anatomical and one psychometric, in a population.

	In this work, the SCCAN implementation of sparse CCA was employed to directly associate the five PBAC sub-scales described above with GM measures taken from the images.   In general, SCCAN elucidates the relationship between two sets of measurements taken across a population and is thus well-suited to multivariate neuroimaging data.  The input to SCCAN is two matrices X and Y.  The size of X is n by p where n is the number of subjects and p is the number of voxels from the cortical gray matter.  The matrix thus collects all cortical imaging data for each subject.  The size of Y is n by q corresponding, here, to the psychometric measures for each subject.  SCCAN maximizes the Pearson correlation, in a rotated space, between weighted averages of the columns of these matrices.   More formally, SCCAN,  like classic CCA, introduces new unknown vectors, x ( p by 1 ) and y ( q by 1 ) that act as weighted averages of X, Y.   The SCCAN optimization criterion is: 

%                                         arg max   Corr( X x, Y y)  -  w || x ||  - v || y ||, 
%			     subject to:    x  >= 0,

where Corr denotes the Pearson correlation, || . || denotes the L1 norm and w, v are scalar weights. The L1 norm forces the solution x to be sparse i.e. have zero value over the majority of the brain.  In this application, v=0.   SCCAN’s objective function can be optimized even when the matrices are “fat” i.e. p >> n, often the case in neuroimaging studies.  Due to the non-linear (even np-hard) nature of subset selection (sparse optimization) from a large matrix, optimizing for a single canonical variate pair, x, y, involves a nonlinear gradient descent on the objective function above. Following this gradient will cause the solution x to leave the permissible solution space and, as such, we follow the gradient update step with a projection step 41. The projection step involves a standard soft-thresholding operation used in L1 optimization which is easily modified to include positivity constraints 20. The gradient for y is obtained at the same time as that for x with a simple switching of indices.

	SCCAN produces a sparse projection vector acting on GM voxels that, taken as a set, maximally correlate with the user-selected PBAC domain of interest.  Here we use the working memory/executive, language, visuospatial, memory, and social/behavioral PBAC sub-scales, thus requiring only five direct multivariate tests, i.e., one for each cognitive domain.  The sparse eigenvectors that emerge from SCCAN identify the brain regions supporting the specific PBAC domain that was passed to the algorithm as the second view.  In this study, we restrict the SCCAN eigenvectors to be positive.  Thus, each eigenvector is a weighted average of values over a restricted region of GM11,20 .  The implementation details are available in the Advanced Normalization Toolkit’s sccan.cxx program which contains the SCCAN source code.  The significance of SCCAN results may be tested by permuting one of the two views over many different simulations.  One then compares the correlation value produced by the original ordering of the data to the correlations produced over the N permutations. Large Ns (>= 10,000) are needed to provide a reasonable sampling of the empirical null distribution.

	\subsection{Parameter Selection}  Our studies used reproducible research practices by employing open methods, standardized parameter sets and version control of both parameters and code via git.  We employed standard parameters in PipeDream and ANTs for template construction, normalization, segmentation and GM estimation. SCCAN was used to extract the single most dominant features to associate GM and a PBAC sub-scale.  The significance of this correlation was assessed empirically by permutation testing relative to randomized data (n= 10,000 for each of the five PBAC sub-scales).  The five p-values were then corrected for multiple comparisons by false discovery rate (FDR).  The sparseness parameters for the SCCAN’s x vectors were chosen by a line search to maximize correlation while excluding GM clusters less than 200 contiguous voxels.  We did not employ sparseness on the 2nd view (the PBAC sub-scale scores). 


\section{Results}
	PBAC Sub-Scales and GM Density:  We found significant associations between GM density and each of the five PBAC sub-scales consistent with putative neuroanatomical substrates at the FDR-corrected p< 0.01 level.  As summarized in Figure 1, PBAC-defined behavior/ social comportment was related to bilateral ventral and medial frontal and insula atrophy that is more prominent on the right than the left.  Poor memory was related to bilateral precuneus, bilateral hippocampus, and bilateral posterior temporal atrophy more prominently on the left than the right.  Significant visuospatial/ constructional impairment was related to bilateral posterior temporal-occipital and bilateral parietal-occipital atrophy.  Impaired language was related to left temporal and left temporal-parietal atrophy extending into left anterior temporal and left inferior frontal regions.  Executive deficits were related to bilateral dorsal and lateral prefrontal atrophy. 

	Clinical Diagnosis and GM Density:  PBAC sub-scales have previously been shown to differentiate between AD and FTLD, and between FTLD phenotypes9,10.  Linear regression was used to relate GM density to the diagnosis of interest while controlling for co-variates including age, education, disease duration.  Here, diagnosis is a binary predictor where a single patient group was compared to all other subjects not in the group of interest.  Results confirm that the weighted average GM density associated with most PBAC sub-scale was significantly related to diagnosis.  Specifically, PBAC behavior/social-related GM regions were related to bvFTD (p< 0.001).  Likewise, PBAC language-related GM regions were related to svPPA (p< 0.008).  PBAC memory-related GM regions were related to AD (p< 0.017) and PBAC visuospatial/ constructional-related GM regions were related to CBS (p< 0.001).  PBAC working memory/ executive-related GM regions were not related to one specific clinical diagnosis.  

\section{Discussion}
The PBAC was designed as a screening instrument to assess overall dementia severity and to differentiate between neurodegenerative syndromes within the AD and FTLD spectrum.  Previous research with the PBAC found a significant correlation between the total PBAC score and the MMSE9,10, thus demonstrating that performance on the instrument reasonably captures overall dementia severity.  PBAC sub-scales also show good clinical utility in distinguishing between AD and FTLD, and between FTLD-spectrum phenotypes using sub-scale cut scores.  The psychometric qualities of the PBAC include good internal consistency among the tests within each PBAC sub-scale and highly significant intra-class correlations between PBAC sub-scales and standard neuropsychological tests10.  PBAC sub-scales also show good clinical utility in distinguishing between AD and FTLD, and between FTLD-related phenotypes using sub-scale cut scores.

The current research used novel imaging methods to provide further evidence for the criterion validity of the PBAC by associating PBAC sub-scale test performance with corresponding areas of GM atrophy.  We found relationships between PBAC-defined areas of GM atrophy, specific domains of cognitive impairment, and clinical diagnosis.  Patients with AD are known to present with striking memory impairment as well as atrophy involving the hippocampus, precuneus and related anatomic structures.  In the current research, the PBAC-memory sub-scale was associated with a clinical diagnosis of AD and GM atrophy involving bilateral hippocampus and precuneus.  Hippocampal and precuneus involvement in clinically-defined patients with anterograde amnesia and AD is well known22,23.  Moreover, prior research with AD and amnesic mild cognitive impairment suggests that these areas are part of a neurocognitive network for memory that also includes superior temporal gyrus24,25.  

bvFTD presents with alterations in behavior and social comportment 2, 26, including apathy, disinhibition, and lack of empathy.  In the current study, the PBAC-behavior/ social scale is related to striking bilateral medial and ventral frontal GM atrophy, perhaps with greater right-sided involvement and the clinical diagnosis of bvFTD.  Previous research has associated these behavioral abnormalities with bilateral ventral and medial frontal atrophy27,28.    
CBS is associated with significant impairment in visuospatial and visuoconstructional tests, as well as some executive deficits29,30.  The current research associates the PBAC-visuospatial/ constructional sub-scale with right posterior GM atrophy.  Prior neuroimaging research with CBS patients is controversial, with some researchers suggesting both parietal and frontal atrophy31 and others only frontal involvement32.  In the present study, atrophy in visual association cortex associated with the visuospatial/constructional sub-scale identified individuals with the clinical diagnosis of CBS.  The executive/ working memory sub-scale is not associated with a single diagnosis but instead is associated with several diagnostic subgroups, including CBS.  This may reflect disease in this subgroup in frontal brain regions sensitive to the executive/ working memory sub-scale.

The PBAC language sub-scale is primarily related to left temporal GM density, with prominent anterior and ventral temporal GM atrophy and a clinical diagnosis of svPPA.  These data are consistent with prior research demonstrating left temporal atrophy in patients with svPPA who have language-related cognitive impairment33,34.  The measures on the PBAC language sub-scale focus mostly on object comprehension, single word expression, reading and writing, with little emphasis on the characteristics important for identifying naPPA12.  It is not surprising in this context that patients with naPPA are not associated with the language sub-scale of the PBAC.  Patients with this syndrome are particularly impaired on measures assessing grammatical processing and speech errors12,35, and these domains of cognitive functioning are not currently part of the PBAC-language sub-scale.  Prior research with the PBAC has shown that patients with naPPA score lower on the PBAC-working memory/ executive sub-scale10,29 confirming executive and working memory deficits in these patients and reflecting their disease centered primarily in the frontal lobe35,36.  Future modifications of the PBAC may include measures to improve detection of the naPPA subgroup.

Finally, the PBAC-working memory/ executive sub-scale is related to dorsal and lateral prefrontal GM atrophy.  Although the PBAC-working memory/executive sub-scale consists of verbally-mediated tests, the frontal atrophy associated with the PBAC-working memory/executive sub-scale is bilateral.  This emphasizes the observation that difficulty on resource-demanding measures such as these is associated with bilateral disease and somewhat independent of the modality of task presentation30.  Because executive and working memory measures involve multiple brain regions often working together with dorsal and lateral prefrontal areas, it is not surprising that this sub-scale is not associated with a single subgroup.  Taken together, these data extend past research to show that PBAC sub-scales are associated with MRI-defined anatomical substrates and that the PBAC is a sensitive clinical screening tool in AD and FTLD syndromes.  

The identified relationships between impaired neurocognitive GM networks and clinically-defined diagnoses in dementia underscore the power of SCCAN over traditional univariate approaches to imaging analysis.  In prior research37, a large group of patients with bvFTD, svPPA and nfPPA were evaluated with ACE and a MRI visual rating scale that graded temporal and frontal lobe atrophy on a 5-point scale38.  In that study, 100% of svPPA patients were judged to have abnormal scans, 71% nfPPA patients were judged to have abnormal scans only 47% of bvFTD patients had abnormal scans.  The cognitive measure was significantly correlated with atrophy in all regions that were measured.  By contrast, there was no general correlation demonstrating increasing behavioral abnormalities with any areas of the brain.  However, for a subset of bvFTD patients, greater behavioral disturbance was correlated with greater atrophy involving bifrontal regions.

Using SCCAN, by comparison, massive dimensionality reduction significantly enhances the empirical ability to detect these clinical-neuroimaging relationships.  Prior work demonstrated the advantages of SCCAN in combining GM and diffusion tensor imaging data to distinguish between autopsy- and CSF-defined cases of AD and FTLD39,40.  The results of the current study reveal that SCCAN is capable of associating multi-dimensional psychometric and neuroimaging data to reveal the large-scale neural networks that are degraded when cognition is compromised in neurodegenerative conditions like AD and FTLD.

This research is not without limitations.  First, the PBAC was not designed nor should it be used to as a substitute for a comprehensive neuropsychological evaluation. This is reflected most clearly in the modest ability of the executive/working memory sub-scale to detect a specific group of patients with prefrontal disease.  Second, the sample size for several groups was relatively modest.  The results of the present study will require confirmation with larger groups of patients.  Third, virtually all work with the PBAC has been confined to differentiating AD from FTLD and to distinguishing between FTLD phenotypes.  The utility of the PBAC in other populations such as Parkinson’s disease, amyotrophic lateral sclerosis, and Mild Cognitive Impairment requires further examination.  Finally, SCCAN associated some unexpected brain regions with a specific cognitive domain.  For example, the insula was associated with the memory sub-scale and an area of the ventral temporal lobe with executive functioning.  Additional work is needed to understand the basis for these associations.  With these limitations in mind, the current study suggests good criterion validity for the PBAC to differentiate between AD and FTLD-related phenotypes, and the power of a multivariate analytic approach such as SCCAN to demonstrate these effects.  


\section{Acknowledgements}
Dr. Grossman receives support from the National Institutes of Health (AG32953, AG17586, AG15116, NS44266, and NS53488) and the Wyncote Foundation, and is a consultant for Bristol Meyers Squibb and Allon Therapeutics.  Dr. Chatterjee receives support from National Institutes of Health (RO1 DC008779, RO1 HD050199] and the National Science Foundation (SBE0541957).  Dr. McMillan receives support from NIH HD0406.  Ms. Massimo receives support from National Institutes of Health (F31NR013306) and John A. Hartford Foundation's Building Academic Geriatric Nursing Capacity Award Program.  Dr. Libon receives support for Bayer Pharmaceuticals.  Drs. Rascovsky and Avants, and Ms. Boller report no disclosures.


<<cca,eval=FALSE>>=

####################
library(ANTsR)
require(visreg) ; library(vegan)
DIR<-paste(getwd(),'/data/',sep='')
resMV<-list()
resUV<-list()
##########################################################################
##########################################################################
demog<-read.csv(paste(DIR,'PBAC_current.csv',sep=''),na.strings = ".")
for ( j in   1:dim(demog)[2] ) {
  demog[,j]<-as.numeric(demog[,j])
}
lookatrows<-grep("adj",names(demog))
testnames=names(demog)
agenthelike<-c(13:15,176)
agenthelike<-c(13:15)
offset<-length(agenthelike)  # this will add the age / mmse to the matrix 
offset<-0                               # only pbac 
testlist<-1:5
for ( opt in testlist ){ # 
if ( opt == 1 ) {
  lookatrows<-c(agenthelike,46:48,63) ; nam<-'exec' # exec + demog
  if ( offset == 0 ) lookatrows<-c(46:48,63) ; nam<-'exec' # exec + demog
}
if ( opt == 2 ) {
  lookatrows<-c(agenthelike,50:54) ; nam<-'lang' # lang + demog
  if ( offset == 0 ) lookatrows<-c(50:54) ; nam<-'lang' # lang + demog
}
if ( opt == 3 ) {
  lookatrows<-c(agenthelike,59:61) ; nam<-'mem' # mem + demog
  if ( offset == 0 ) lookatrows<-c(59:61) ; nam<-'mem' # mem + demog
}
if ( opt == 4 ) {
  lookatrows<-c(agenthelike,56,57) ; nam<-'vs' # vs + demog
  if ( offset == 0 ) lookatrows<-c(56,57) ; nam<-'vs' # vs + demog
}
if ( opt == 5 ) {
  lookatrows<-c(agenthelike,36,37,39,40,41) ; nam<-'behav' # behav + demog
  lookatrows<-c(agenthelike,37:43) ; nam<-'behav' # behav + demog
  if ( offset == 0 ) lookatrows<-c(37:43) ; nam<-'behav' # behav + demog
}
print(opt)
print(names(demog)[lookatrows])
#
# should probably assess significance in terms of clusters of cog vars -- JOLO judgement line orientation
# 
lookatrowsscore<-rep(0,length(lookatrows))
havefrac<-0.96
IMGLISTGM<-Sys.glob("data/images/*nii.gz")
haveGM<-rep(FALSE,length(demog$pt_id))
GImageAddedAlready<-rep(FALSE,length(IMGLISTGM))
GIMAGELISTFORTHISSTUDY<-c("")
for ( i in 1:length(demog$pt_id) ){
  ID<-sub(",","",demog$pt_id[i])
  qct<-1
  for ( q in IMGLISTGM ) {
      bb<-grep(ID,q) # check if image has the right ID 
      filereadable<-file.access(q,mode=4) # check if image is there 
      if ( length(bb) == 1 & filereadable == 0  & GImageAddedAlready[qct] == 0  & haveGM[i] == 0 ) 
        {
                if ( sum(GImageAddedAlready) > 0 ){ 
                 GIMAGELISTFORTHISSTUDY<-paste(GIMAGELISTFORTHISSTUDY,q,sep='\n')
                }
                else {
                 GIMAGELISTFORTHISSTUDY<-paste(q,sep='\n')
                }
                GImageAddedAlready[qct]<-1
                haveGM[i]<-TRUE
                alreadyadded<-TRUE
         }
     qct<-qct+1 
      }
}
imglist<-strsplit(GIMAGELISTFORTHISSTUDY,'\n')[[1]]
print(lookatrowsscore)
WHICH<-which(  haveGM == TRUE ) 
nsub<-(length(WHICH))
# now we need to find out which tests are well represented ...
# below -- these rows have 100% hit rates 
fullrows<-c("")
for ( cols in lookatrows ){
  havecol<-sum(as.numeric(!is.na(demog[WHICH,cols])))
  havecol<-havecol/length(WHICH)
  tt<-sd(demog[WHICH,cols])
  if ( havecol == 1 & !is.na(tt) & tt > 0 ) {
    fullrows<-c(fullrows,cols)
  }
}
fullrows<-fullrows[2:length(fullrows)]
nc<-length(fullrows)
tt1p<-0 ; tt2p<-0 ; tt3p<-0 ; rval<-0.8
ct<-1
while ( tt1p < rval | tt2p < rval | tt3p < rval & ct < 550 ) {
  permutesubsin<-sample(1:nsub)
  w1<-round(length(permutesubsin)*0.5) # subset selection
  w2<-w1+1
  permutesubs<-permutesubsin[1:w1]# seq(1,nsub,by=2)
  permutesubs2<-permutesubsin[w2:nsub]# seq(2,nsub,by=2)
  tt1p<-t.test( demog[permutesubs,13] , demog[permutesubs2,13] )$p.value
  tt2p<-t.test( demog[permutesubs,14] , demog[permutesubs2,14] )$p.value
  tt3p<-t.test( demog[permutesubs,15] , demog[permutesubs2,15] )$p.value
  ct<-ct+1
}
print(paste("Split:",length(permutesubs),length(permutesubs2),tt1p,tt2p,tt3p))
# here split the age/edu from the rest 
print(paste("nsub",nsub,"nc",nc,"opt",nam))
cogmat<-matrix(NA,nsub,nc-offset)
ct<-1
nms<-rep(NA,nc)
for ( x in (offset+1):nc ) {
  cogmat[,ct]<-as.numeric(demog[WHICH,as.numeric(fullrows[x])])
  nms[x]<-names(demog)[as.numeric(fullrows[x])]
 ct<-ct+1
}
cogmat<-decostand(cogmat,method='standardize',margin=2)
nw<-1:ncol(cogmat)
#
#######################################################################
#
 thmask<-paste(DIR,"gmask_2mmb.nii.gz",sep='')
maskimg<-antsImageRead(thmask,3)
mask<-maskimg == 1
trainmat<-matrix(NA,length(permutesubs),sum(mask))
ct<-1
for ( fn in imglist[permutesubs] ) {
  vec<-antsImageRead(fn,3)
  trainmat[ct,]<-subset( vec, mask )
  ct<-ct+1
}
testmat<-matrix(NA,length(permutesubs2),sum(mask))
ct<-1
for ( fn in imglist[permutesubs2] ) {
  vec<-antsImageRead(fn,3)
  testmat[ct,]<-subset( vec, mask )
  ct<-ct+1
}
testmat<-(decostand( testmat , method='standardize',margin=2))
trainmat<-(decostand( trainmat , method='standardize',margin=2))

# do the univariate test to get the sparseness param 
  print("UNIVARIATE")
   unames<-names(demog)[grep("scale_adj",names(demog))]
   voxside<-" ~ vox + age + edu + mmse "
   if ( nam == "exec" ) myform<-as.formula( paste( unames[1], voxside ) )
   if ( nam == "lang" ) myform<-as.formula( paste( unames[2], voxside ) )
   if ( nam == "vs" ) myform<-as.formula( paste( unames[3], voxside ) )
   if ( nam == "mem" ) myform<-as.formula( paste( unames[5], voxside ) )
   if ( nam == "behav" ) myform<-as.formula( paste( unames[6], voxside ) )
   print( myform )
   bynum<-100
   ss<-seq(1,ncol(trainmat),by=bynum)
   ntests<-length( ss )
   progress <- txtProgressBar( min = 0, max = ntests,  style = 3 )
   upvs<-rep(1, ntests )
   ict<-1
   for ( i in ss )
     {
     vox<-trainmat[,i]
     fit<-lm( myform,  data=demog[permutesubs,] )
     upvs[ict]<-coefficients(summary(fit))[2,4]
     if( i %% 1000 == 0 )
       {
         setTxtProgressBar( progress, i )
       }
     ict<-ict+1
     }
   sigfrac <- sum( upvs < 0.05 ) / ntests * 5.0
   print("")
   print( paste("UVar-Significance0.05", sigfrac * 100,"0.01",sum( upvs < 0.01 ) / length( mask ) * 100 ) )
  if ( sigfrac < 0.01 ) sigfrac <- 0.01 
  qvsm <- 1 - upvs
  qvsm <- ( qvsm - min( qvsm ) ) 
  qvsm <-  qvsm / max( qvsm )
  qvsm<-matrix( upvs , nrow=1 )
  qvsm[ is.na( qvsm ) ]<-0
  vox<-testmat  %*% t( qvsm  )
  fit<-lm( myform,  data=demog[permutesubs2,] )
  uvimg<-antsImageClone( maskimg )
  uvimg[ mask ]<-upvs 
  antsImageWrite(  uvimg , paste(DIR,nam,"_uv.nii.gz",sep='') )
  resUV <- lappend( resUV , c( nam, coefficients(summary(fit))[2,4] ) )
  print( summary( fit ) ) 

# now do the multi-variate equivalent
  print(paste("MULTIVARIATE",sigfrac))
ff<-sparseDecom2( inmatrix = list( trainmat,cogmat[permutesubs,nw] )  ,  inmask = c(maskimg, NA),  sparseness=c( sigfrac ,-1),nvecs=2,its=25,cthresh=c(0,0),perms=0,uselong=0,z=0,smooth=1 )
myproj1a<-trainmat %*% t( imageListToMatrix( ff$eig1 , maskimg ) )
myproj1b<-cogmat[permutesubs,nw] %*% as.matrix( ff$eig2 ) 
myproj2a<-testmat  %*% t( imageListToMatrix( ff$eig1 , maskimg ) )
myproj2b<-cogmat[permutesubs2,nw] %*% as.matrix( ff$eig2 ) 

  imaging<-myproj2a[,1]
  cognition<-myproj2b[,1] 
  fit<-lm( cognition ~ imaging )
  print( summary( fit ) )
  pdf(paste('sccanpredict',nam,'_',sigfrac,'.pdf',sep=''))
  mytitle<-paste('Testing SCCAN Prediction: Thickness & ',nam,sep='')
  visreg(fit,main=mytitle,xlab='Thickness',ylab=nam)
  dev.off()
  antsImageWrite(  ff$eig1[[1]] , paste(DIR,nam,".nii.gz",sep='') )
  resMV<- lappend( resMV , c( nam, coefficients(summary(fit))[2,4] ) )

  print( paste(nam,'done') )

}


@ 


\bibliographystyle{IEEEtran}
\bibliography{src/cca}
\end{document}
